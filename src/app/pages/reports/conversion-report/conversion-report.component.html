<div class="report-container">
    <div class="page-header">
        <h4 class="page-title">Conversion Report</h4>
        <div class="date-range">
            <i class="fas fa-calendar-alt me-2"></i>
            <input type="date" class="form-control form-control-sm" [(ngModel)]="startDate">
            <span class="date-separator">-</span>
            <input type="date" class="form-control form-control-sm" [(ngModel)]="endDate">
        </div>
    </div>

    <div class="action-toolbar">
        <div class="toolbar-left">
            <span class="total-count fw-bold me-3">{{totalConversions}} Conversions</span>
            <a href="#" class="small text-muted text-decoration-none">To know more, click here. <i
                    class="fas fa-external-link-alt small"></i></a>
        </div>
        <div class="toolbar-right">
            <div class="dropdown download-dropdown">
                <button class="btn btn-dark btn-sm" (click)="toggleDownloadMenu()">
                    <i class="fas fa-download me-1"></i> Download <i class="fas fa-chevron-down ms-1"></i>
                </button>
                <ul class="dropdown-menu" [style.display]="showDownloadMenu ? 'block' : 'none'">
                    <li><a class="dropdown-item" href="javascript:void(0)" (click)="downloadCSV()"><i
                                class="fas fa-file-csv me-2"></i> CSV</a></li>
                    <li><a class="dropdown-item" href="javascript:void(0)" (click)="downloadExcel()"><i
                                class="fas fa-file-excel me-2"></i> Excel</a></li>
                    <li><a class="dropdown-item" href="javascript:void(0)" (click)="downloadPDF()"><i
                                class="fas fa-file-pdf me-2"></i> PDF</a></li>
                </ul>
            </div>
            <button class="btn btn-primary btn-sm" (click)="createNewReport()"><i class="fas fa-plus me-1"></i> New
                Report</button>
            <div class="search-box"><label>Search:</label><input type="text" class="form-control form-control-sm"
                    [(ngModel)]="searchQuery"></div>
        </div>
    </div>

    <div class="content-card">
        <!-- Horizontally scrollable table wrapper -->
        <div class="table-scroll-wrapper">
            <table class="table table-striped table-hover align-middle mb-0 conversion-table">
                <thead>
                    <tr>
                        <!-- Checkbox Column (always visible) -->
                        <th class="sticky-col checkbox-col">
                            <input type="checkbox" class="form-check-input" [(ngModel)]="selectAll"
                                (change)="toggleSelectAll()">
                        </th>
                        <!-- Dynamic Columns based on selected report options -->
                        <ng-container *ngFor="let col of getVisibleColumns(); let i = index">
                            <th [class.sticky-col]="i === 0" [class.publisher-col]="col.id === 'opt_publisher_name'"
                                [class.text-end]="col.type === 'currency'" class="sortable">
                                {{col.label}} <i class="fas fa-sort ms-1"></i>
                            </th>
                        </ng-container>
                        <!-- Status Column (always visible) -->
                        <th class="sortable">Status <i class="fas fa-sort ms-1"></i></th>
                        <!-- Action Column (always visible) -->
                        <th class="text-center">Action</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let item of filteredData">
                        <!-- Checkbox -->
                        <td class="sticky-col checkbox-col">
                            <input type="checkbox" class="form-check-input" [(ngModel)]="item.selected">
                        </td>
                        <!-- Dynamic Columns -->
                        <ng-container *ngFor="let col of getVisibleColumns(); let i = index">
                            <td [class.sticky-col]="i === 0" [class.publisher-col]="col.id === 'opt_publisher_name'"
                                [class.text-end]="col.type === 'currency'" [class.nowrap]="col.type === 'datetime'">

                                <!-- Link type -->
                                <ng-container *ngIf="col.type === 'link'">
                                    <a *ngIf="col.dataKey === 'publisher'"
                                        [routerLink]="['/publishers', item.publisherId]" class="item-link">
                                        (ID: {{item.publisherId}}) {{item.publisher}}
                                    </a>
                                    <a *ngIf="col.dataKey === 'campaign'" [routerLink]="['/campaigns', item.campaignId]"
                                        class="item-link">
                                        (ID: {{item.campaignId}}) {{item.campaign}}
                                    </a>
                                    <a *ngIf="col.dataKey === 'advertiser'" href="#" class="item-link">
                                        (ID: {{item.advertiserId}}) {{item.advertiser}}
                                    </a>
                                </ng-container>

                                <!-- Currency type -->
                                <ng-container *ngIf="col.type === 'currency'">
                                    ₹ {{getCellValue(item, col.dataKey)?.toFixed ? getCellValue(item,
                                    col.dataKey).toFixed(2) : '0.00'}}
                                </ng-container>

                                <!-- Code type -->
                                <ng-container *ngIf="col.type === 'code'">
                                    <code class="id-code">{{getCellValue(item, col.dataKey)}}</code>
                                </ng-container>

                                <!-- Badge type -->
                                <ng-container *ngIf="col.type === 'badge'">
                                    <span
                                        *ngIf="getCellValue(item, col.dataKey) && getCellValue(item, col.dataKey) !== '--'"
                                        class="badge" [class.bg-info]="col.dataKey === 'conversionMethod'"
                                        [class.bg-light]="col.dataKey !== 'conversionMethod'"
                                        [class.text-white]="col.dataKey === 'conversionMethod'"
                                        [class.text-dark]="col.dataKey !== 'conversionMethod'">
                                        {{getCellValue(item, col.dataKey)}}
                                    </span>
                                    <span
                                        *ngIf="!getCellValue(item, col.dataKey) || getCellValue(item, col.dataKey) === '--'">--</span>
                                </ng-container>

                                <!-- Country type -->
                                <ng-container *ngIf="col.type === 'country'">
                                    <span class="country-cell">
                                        <span class="country-flag">{{getFlagEmoji(item.countryCode)}}</span>
                                        {{getCellValue(item, col.dataKey)}}
                                    </span>
                                </ng-container>

                                <!-- Datetime type -->
                                <ng-container *ngIf="col.type === 'datetime'">
                                    {{getCellValue(item, col.dataKey)}}
                                </ng-container>

                                <!-- Text type (default) -->
                                <ng-container *ngIf="col.type === 'text'">
                                    {{getCellValue(item, col.dataKey)}}
                                </ng-container>
                            </td>
                        </ng-container>
                        <!-- Status -->
                        <td><span class="badge" [class]="getStatusClass(item.status)">{{item.status}}</span></td>
                        <!-- Action -->
                        <td class="text-center">
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button"
                                    data-bs-toggle="dropdown">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li><a class="dropdown-item" href="#"><i class="fas fa-eye me-2"></i>View
                                            Details</a></li>
                                    <li><a class="dropdown-item" href="#"><i class="fas fa-edit me-2"></i>Edit</a></li>
                                    <li><a class="dropdown-item text-danger" href="#"><i
                                                class="fas fa-trash me-2"></i>Delete</a></li>
                                </ul>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="pagination-info">Showing 1 to {{filteredData.length}} of {{filteredData.length}} entries</div>
    </div>

    <button class="filter-fab" (click)="toggleFilterPanel()" title="Search Filter"><i
            class="fas fa-filter"></i></button>

    <!-- Filter Sidebar Overlay -->
    <div class="filter-sidebar-overlay" *ngIf="showFilterPanel" (click)="closeFilterPanel()"></div>

    <!-- Filter Sidebar - Trackier Style Right Side -->
    <div class="filter-sidebar" [class.open]="showFilterPanel">
        <div class="filter-sidebar-header">
            <h5>Filters</h5>
            <div class="header-actions">
                <button class="btn btn-sm btn-link text-primary" (click)="switchFilterView()">
                    Switch to {{filterView === 'old' ? 'New' : 'Old'}} Filter
                </button>
                <button type="button" class="btn-close" (click)="closeFilterPanel()"></button>
            </div>
        </div>

        <div class="filter-sidebar-body">
            <!-- Campaign -->
            <div class="filter-group">
                <label class="filter-label">Campaign</label>
                <input type="text" class="form-control form-control-sm" [(ngModel)]="filters.campaign"
                    placeholder="Search campaigns..">
            </div>

            <!-- Publisher -->
            <div class="filter-group">
                <label class="filter-label">Publisher</label>
                <input type="text" class="form-control form-control-sm" [(ngModel)]="filters.publisher"
                    placeholder="Choose one or many Publisher">
            </div>

            <!-- Click ID -->
            <div class="filter-group">
                <label class="filter-label">Click ID</label>
                <input type="text" class="form-control form-control-sm" [(ngModel)]="filters.clickId"
                    placeholder="Click ID">
            </div>

            <!-- Click IP -->
            <div class="filter-group">
                <label class="filter-label">Click IP</label>
                <input type="text" class="form-control form-control-sm" [(ngModel)]="filters.clickIp"
                    placeholder="Click IP">
            </div>

            <!-- Conversion ID -->
            <div class="filter-group">
                <label class="filter-label">Conversion ID</label>
                <input type="text" class="form-control form-control-sm" [(ngModel)]="filters.conversionId"
                    placeholder="Conversion ID">
            </div>

            <!-- Conversion IP -->
            <div class="filter-group">
                <label class="filter-label">Conversion IP</label>
                <input type="text" class="form-control form-control-sm" [(ngModel)]="filters.conversionIp"
                    placeholder="Conversion IP">
            </div>

            <!-- Advertiser -->
            <div class="filter-group">
                <label class="filter-label">Advertiser</label>
                <input type="text" class="form-control form-control-sm" [(ngModel)]="filters.advertiser"
                    placeholder="Choose one or many Advertiser">
            </div>

            <!-- TXN ID -->
            <div class="filter-group">
                <label class="filter-label">TXN ID</label>
                <input type="text" class="form-control form-control-sm" [(ngModel)]="filters.txnId"
                    placeholder="Txn ID">
            </div>

            <!-- Source -->
            <div class="filter-group">
                <label class="filter-label">Source</label>
                <input type="text" class="form-control form-control-sm" [(ngModel)]="filters.source"
                    placeholder="Source">
            </div>

            <!-- Goal Name -->
            <div class="filter-group">
                <label class="filter-label">Goal Name</label>
                <input type="text" class="form-control form-control-sm" [(ngModel)]="filters.goalName"
                    placeholder="Goal Name Filter">
                <small class="form-text text-muted">To view goal specific conversions. Type the name of the
                    goal...</small>
            </div>

            <!-- Status -->
            <div class="filter-group">
                <label class="filter-label">Status</label>
                <select class="form-select form-select-sm" [(ngModel)]="filters.status">
                    <option value="all">ALL</option>
                    <option value="approved">Approved</option>
                    <option value="pending">Pending</option>
                    <option value="rejected">Rejected</option>
                    <option value="trash">Trash</option>
                </select>
            </div>

            <!-- Conversion Method -->
            <div class="filter-group">
                <label class="filter-label">Conversion Method</label>
                <select class="form-select form-select-sm" [(ngModel)]="filters.conversionMethod">
                    <option value="all">All</option>
                    <option value="postback">Postback</option>
                    <option value="pixel">Pixel</option>
                    <option value="server">Server</option>
                </select>
            </div>

            <!-- Smart Link -->
            <div class="filter-group">
                <label class="filter-label">Smart Link</label>
                <input type="text" class="form-control form-control-sm" [(ngModel)]="filters.smartLink"
                    placeholder="Choose one or many smartLinks">
            </div>

            <!-- External Offer IDs -->
            <div class="filter-group">
                <label class="filter-label">External Offer IDs</label>
                <input type="text" class="form-control form-control-sm" [(ngModel)]="filters.externalOfferIds"
                    placeholder="External Offer IDs">
            </div>

            <!-- Fields Section -->
            <div class="fields-section">
                <label class="filter-label">Fields</label>
                <div class="selected-fields">
                    <span class="field-tag" *ngFor="let field of getSelectedFieldTags()">
                        {{field.label}}
                        <button class="tag-remove" (click)="removeField(field.id)">×</button>
                    </span>
                </div>
                <a href="javascript:void(0)" class="add-more-link" (click)="openFieldsModal()">
                    <i class="fas fa-plus me-1"></i> Add more columns
                </a>
            </div>
        </div>

        <div class="filter-sidebar-footer">
            <button class="btn btn-primary" (click)="applyFilters()">Apply</button>
            <button class="btn btn-outline-secondary" (click)="closeFilterPanel()">Close</button>
        </div>
    </div>

    <!-- Fields Selection Modal -->
    <div class="fields-modal-overlay" *ngIf="showFieldsModal" (click)="closeFieldsModal()"></div>
    <div class="fields-modal" *ngIf="showFieldsModal">
        <div class="fields-modal-header">
            <input type="text" class="form-control form-control-sm search-fields" [(ngModel)]="reportOptionSearch"
                placeholder="Search fields...">
            <div class="header-actions">
                <button class="btn btn-sm btn-link" (click)="clearAllReportOptions()" title="Clear all">
                    <i class="fas fa-times"></i>
                </button>
                <button class="btn btn-sm btn-link" (click)="selectAllReportOptions()" title="Select all">
                    <i class="fas fa-check-double"></i>
                </button>
                <button type="button" class="btn-close" (click)="closeFieldsModal()"></button>
            </div>
        </div>
        <div class="fields-modal-body">
            <div class="fields-grid fields-grid-5">
                <!-- Column 1 - Publisher Info -->
                <div class="fields-column">
                    <div class="form-check" *ngFor="let option of getFilteredOptions(reportOptionsCol1)">
                        <input class="form-check-input" type="checkbox" [(ngModel)]="option.selected" [id]="option.id">
                        <label class="form-check-label" [for]="option.id">{{option.label}}</label>
                    </div>
                </div>

                <!-- Column 2 - Advertiser & Sub-IDs -->
                <div class="fields-column">
                    <div class="form-check" *ngFor="let option of getFilteredOptions(reportOptionsCol2)">
                        <input class="form-check-input" type="checkbox" [(ngModel)]="option.selected" [id]="option.id">
                        <label class="form-check-label" [for]="option.id">{{option.label}}</label>
                    </div>
                </div>

                <!-- Column 3 - Campaign & Financials -->
                <div class="fields-column">
                    <div class="form-check" *ngFor="let option of getFilteredOptions(reportOptionsCol3)">
                        <input class="form-check-input" type="checkbox" [(ngModel)]="option.selected" [id]="option.id">
                        <label class="form-check-label" [for]="option.id">{{option.label}}</label>
                    </div>
                </div>

                <!-- Column 4 - Geo & Technical -->
                <div class="fields-column">
                    <div class="form-check" *ngFor="let option of getFilteredOptions(reportOptionsCol4)">
                        <input class="form-check-input" type="checkbox" [(ngModel)]="option.selected" [id]="option.id">
                        <label class="form-check-label" [for]="option.id">{{option.label}}</label>
                    </div>
                </div>

                <!-- Column 5 - Conversion Details -->
                <div class="fields-column">
                    <div class="form-check" *ngFor="let option of getFilteredOptions(reportOptionsCol5)">
                        <input class="form-check-input" type="checkbox" [(ngModel)]="option.selected" [id]="option.id">
                        <label class="form-check-label" [for]="option.id">{{option.label}}</label>
                    </div>
                </div>
            </div>
        </div>
        <div class="fields-modal-footer">
            <span class="text-muted small">Please select atmax 20 Fields for export</span>
        </div>
    </div>

    <div class="modal-overlay" *ngIf="showNewReportModal" (click)="closeNewReportModal()"></div>
    <div class="new-report-modal" *ngIf="showNewReportModal">
        <div class="modal-header">
            <h5 class="modal-title">Create New Report</h5>
        </div>
        <div class="modal-body"><input type="text" class="form-control" [(ngModel)]="newReportName"
                placeholder="Enter Report Name" (keyup.enter)="confirmNewReport()"></div>
        <div class="modal-footer"><button class="btn btn-primary btn-sm"
                (click)="confirmNewReport()">Yes</button><button class="btn btn-outline-secondary btn-sm"
                (click)="closeNewReportModal()">Cancel</button></div>
    </div>
</div>
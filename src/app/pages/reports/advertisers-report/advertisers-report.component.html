<div class="report-container">
    <div class="page-header">
        <h4 class="page-title">Advertisers Report</h4>
    </div>

    <div class="control-bar">
        <div class="control-left">
            <div class="control-group">
                <label class="control-label">Saved Reports</label>
                <select class="form-select form-select-sm">
                    <option *ngFor="let report of savedReportsList" [value]="report.value">{{report.label}}</option>
                </select>
            </div>
            <a href="#" class="help-link">To know more, click here.</a>
        </div>
        <div class="control-right">
            <div class="view-toggle">
                <button class="btn btn-sm" [class.active]="viewMode === 'table'" (click)="setViewMode('table')"><i
                        class="fas fa-table"></i></button>
                <button class="btn btn-sm" [class.active]="viewMode === 'chart'" (click)="setViewMode('chart')"><i
                        class="fas fa-chart-bar"></i></button>
            </div>
            <div class="date-range">
                <i class="fas fa-calendar-alt me-2"></i>
                <input type="text" ngxDaterangepickerMd [(ngModel)]="selected" [ranges]="ranges"
                    [showCustomRangeLabel]="true" [alwaysShowCalendars]="false" [linkedCalendars]="true"
                    [showClearButton]="false" [locale]="locale" (datesUpdated)="choosedDate($event)" [autoApply]="false"
                    [showRangeLabelOnInput]="true" [drops]="'down'" [opens]="'left'"
                    class="form-control form-control-sm date-picker-input" placeholder="Select date range" readonly />
            </div>
        </div>
    </div>

    <div class="action-toolbar">
        <div class="toolbar-left">
            <div class="dropdown download-dropdown">
                <button class="btn btn-dark btn-sm" (click)="toggleDownloadMenu()">
                    <i class="fas fa-download me-1"></i> Download <i class="fas fa-chevron-down ms-1"></i>
                </button>
                <ul class="dropdown-menu" [style.display]="showDownloadMenu ? 'block' : 'none'">
                    <li><a class="dropdown-item" href="javascript:void(0)" (click)="downloadCSV()"><i
                                class="fas fa-file-csv me-2"></i> CSV</a></li>
                    <li><a class="dropdown-item" href="javascript:void(0)" (click)="downloadExcel()"><i
                                class="fas fa-file-excel me-2"></i> Excel</a></li>
                    <li><a class="dropdown-item" href="javascript:void(0)" (click)="downloadPDF()"><i
                                class="fas fa-file-pdf me-2"></i> PDF</a></li>
                </ul>
            </div>
            <button class="btn btn-primary btn-sm" (click)="createNewReport()"><i class="fas fa-plus me-1"></i> New
                Report</button>
        </div>
        <div class="toolbar-right">
            <div class="search-box"><label>Search:</label><input type="text" class="form-control form-control-sm"
                    [(ngModel)]="searchQuery"></div>
        </div>
    </div>

    <div class="content-card">
        <!-- Loading State -->
        <div *ngIf="loading" class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2 text-muted">Loading advertiser report...</p>
        </div>

        <!-- Error State -->
        <div *ngIf="error && !loading" class="alert alert-danger m-3" role="alert">
            <i class="fas fa-exclamation-circle me-2"></i>
            {{ error }}
        </div>

        <!-- No Results Found -->
        <div *ngIf="!loading && !error && filteredData.length === 0" class="text-center py-5">
            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">No Results Found</h5>
            <p class="text-muted small">No advertiser data available for the selected range.</p>
        </div>

        <div class="table-responsive" *ngIf="viewMode === 'table' && !loading && !error && filteredData.length > 0">
            <table class="table table-striped table-hover align-middle mb-0">
                <thead>
                    <tr>
                        <th *ngFor="let col of getVisibleColumns()" class="sortable"
                            [class.text-end]="getColumnType(col.key) !== 'text'"
                            [class.text-start]="getColumnType(col.key) === 'text'">
                            {{col.label}} <i class="fas fa-sort ms-1"></i>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let item of filteredData">
                        <td *ngFor="let col of getVisibleColumns()" [class.text-end]="getColumnType(col.key) !== 'text'"
                            [class.text-start]="getColumnType(col.key) === 'text'">

                            <ng-container [ngSwitch]="getColumnType(col.key)">
                                <span *ngSwitchCase="'currency'">{{formatCurrency(item[col.key])}}</span>
                                <span *ngSwitchCase="'percent'">{{formatNumber(item[col.key])}}%</span>
                                <span *ngSwitchCase="'number'">{{formatNumber(item[col.key])}}</span>

                                <ng-container *ngSwitchCase="'text'">
                                    <ng-container *ngIf="col.key === 'advertiser'; else simpleText">
                                        <a href="#" class="item-link fw-bold">{{item.advertiser}}</a>
                                        <div class="small text-muted" *ngIf="item.advertiserId">ID:
                                            {{item.advertiserId}}</div>
                                    </ng-container>
                                    <ng-template #simpleText>
                                        {{item[col.key] || '--'}}
                                    </ng-template>
                                </ng-container>

                            </ng-container>
                        </td>
                    </tr>
                </tbody>
                <tfoot>
                    <tr class="totals-row">
                        <td *ngFor="let col of getVisibleColumns()" [class.text-end]="getColumnType(col.key) !== 'text'"
                            [class.text-start]="getColumnType(col.key) === 'text'">

                            <ng-container [ngSwitch]="getColumnType(col.key)">
                                <strong *ngSwitchCase="'currency'">{{formatCurrency(getTotal(col.key))}}</strong>
                                <strong *ngSwitchCase="'percent'">--</strong>
                                <strong *ngSwitchCase="'number'">{{formatNumber(getTotal(col.key))}}</strong>
                                <strong *ngSwitchCase="'text'">
                                    <span *ngIf="col.key === 'advertiser'">Total</span>
                                </strong>
                            </ng-container>
                        </td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <!-- Pagination -->
        <div class="d-flex justify-content-between align-items-center p-3 border-top"
            *ngIf="viewMode === 'table' && !loading && !error && filteredData.length > 0">
            <div class="d-flex align-items-center">
                <select class="form-select form-select-sm me-2" style="width: auto;" [(ngModel)]="pageSize"
                    (ngModelChange)="onPageSizeChange()">
                    <option [ngValue]="10">10</option>
                    <option [ngValue]="25">25</option>
                    <option [ngValue]="50">50</option>
                    <option [ngValue]="100">100</option>
                </select>
                <span class="text-muted small">Rows per page</span>
            </div>

            <ngb-pagination [(page)]="currentPage" [pageSize]="pageSize" [collectionSize]="totalCount" [maxSize]="5"
                [rotate]="true" [boundaryLinks]="true" (pageChange)="onPageChange($event)">
            </ngb-pagination>
        </div>

        <div class="chart-container" *ngIf="viewMode === 'chart'">
            <div class="chart-placeholder"><i class="fas fa-chart-bar fa-4x text-muted mb-3"></i>
                <p class="text-muted">Chart visualization will be displayed here</p>
            </div>
        </div>
    </div>

    <button class="filter-fab" (click)="toggleFilterPanel()" title="Search Filter"><i
            class="fas fa-filter"></i></button>
    <div class="filter-overlay" *ngIf="showFilterPanel" (click)="closeFilterPanel()"></div>

    <div class="filter-panel" [class.open]="showFilterPanel">
        <div class="filter-header">
            <h5><i class="fas fa-filter me-2"></i> Search Filter</h5><button type="button" class="btn-close"
                (click)="closeFilterPanel()"></button>
        </div>
        <div class="filter-body">
            <div class="filter-section">
                <div class="row mb-3">
                    <div class="col-6">
                        <label class="form-label">Campaign</label>
                        <input type="text" class="form-control form-control-sm" [(ngModel)]="filters.campaign"
                            placeholder="Search campaign...">
                        <div class="form-check mt-1"><input class="form-check-input" type="checkbox"
                                [(ngModel)]="filters.campaignSearchById" id="campaignById"><label
                                class="form-check-label small" for="campaignById">Search By IDs</label></div>
                    </div>
                    <div class="col-6">
                        <label class="form-label">Publisher</label>
                        <input type="text" class="form-control form-control-sm" [(ngModel)]="filters.publisher"
                            placeholder="Search publisher...">
                        <div class="form-check mt-1"><input class="form-check-input" type="checkbox"
                                [(ngModel)]="filters.publisherSearchById" id="publisherById"><label
                                class="form-check-label small" for="publisherById">Search By IDs</label></div>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-6">
                        <label class="form-label">Advertiser</label>
                        <input type="text" class="form-control form-control-sm" [(ngModel)]="filters.advertiser"
                            placeholder="Search advertiser...">
                        <div class="form-check mt-1"><input class="form-check-input" type="checkbox"
                                [(ngModel)]="filters.advertiserSearchById" id="advertiserById"><label
                                class="form-check-label small" for="advertiserById">Search By IDs</label></div>
                    </div>
                </div>
                <div class="quick-filters">
                    <div class="form-check form-check-inline"><input class="form-check-input" type="checkbox"
                            [(ngModel)]="filters.campaignGeo" id="filterCampaignGeo"><label class="form-check-label"
                            for="filterCampaignGeo">Campaign GEO</label></div>
                    <div class="form-check form-check-inline"><input class="form-check-input" type="checkbox"
                            [(ngModel)]="filters.teamMember" id="filterTeamMember"><label class="form-check-label"
                            for="filterTeamMember">Team Member</label></div>
                    <div class="form-check form-check-inline"><input class="form-check-input" type="checkbox"
                            [(ngModel)]="filters.advertiserTags" id="filterAdvertiserTags"><label
                            class="form-check-label" for="filterAdvertiserTags">Advertiser Tags</label></div>
                    <div class="form-check form-check-inline"><input class="form-check-input" type="checkbox"
                            [(ngModel)]="filters.publisherTags" id="filterPublisherTags"><label class="form-check-label"
                            for="filterPublisherTags">Publisher Tags</label></div>
                    <div class="form-check form-check-inline"><input class="form-check-input" type="checkbox"
                            [(ngModel)]="filters.campaignAppId" id="filterCampaignAppId"><label class="form-check-label"
                            for="filterCampaignAppId">Campaign App ID</label></div>
                    <div class="form-check form-check-inline"><input class="form-check-input" type="checkbox"
                            [(ngModel)]="filters.category" id="filterCategory"><label class="form-check-label"
                            for="filterCategory">Category</label></div>
                    <div class="form-check form-check-inline"><input class="form-check-input" type="checkbox"
                            [(ngModel)]="filters.smartLink" id="filterSmartLink"><label class="form-check-label"
                            for="filterSmartLink">Smart Link</label></div>
                </div>
            </div>

            <div class="filter-section">
                <div class="section-header">
                    <h6 class="section-title">Group By <i class="fas fa-cog"></i></h6>
                    <div class="section-actions"><input type="text" class="form-control form-control-sm search-input"
                            [(ngModel)]="groupBySearch" placeholder="Search"><button type="button"
                            class="btn btn-link btn-sm" (click)="clearGroupBy()">Clear</button><button type="button"
                            class="btn btn-link btn-sm" (click)="selectAllGroupBy()">Select All</button></div>
                </div>
                <div class="checkbox-grid grid-5">
                    <div class="form-check" *ngFor="let option of filteredGroupByOptions; trackBy: trackByKey"><input
                            class="form-check-input" type="checkbox" [(ngModel)]="option.checked"
                            [id]="'group_' + option.key"><label class="form-check-label"
                            [for]="'group_' + option.key">{{option.label}}</label></div>
                </div>
            </div>

            <div class="filter-section">
                <div class="section-header">
                    <h6 class="section-title">Report Options <i class="fas fa-cog"></i></h6>
                    <div class="section-actions"><input type="text" class="form-control form-control-sm search-input"
                            [(ngModel)]="metricsSearch" placeholder="Search"><button type="button"
                            class="btn btn-link btn-sm" (click)="clearMetrics()">Clear</button><button type="button"
                            class="btn btn-link btn-sm" (click)="selectAllMetrics()">Select All</button></div>
                </div>
                <div class="checkbox-grid grid-5">
                    <div class="form-check" *ngFor="let metric of filteredMetricsOptions; trackBy: trackByKey"><input
                            class="form-check-input" type="checkbox" [(ngModel)]="metric.checked"
                            [id]="'metric_' + metric.key"><label class="form-check-label"
                            [for]="'metric_' + metric.key">{{metric.label}}</label></div>
                </div>
            </div>

            <div class="filter-section">
                <h6 class="section-title">Other options:</h6>
                <div class="other-options-grid">
                    <div class="form-check"><input class="form-check-input" type="checkbox"
                            [(ngModel)]="otherOptions.onlyShowRowsHavingConversions" id="optConversions"><label
                            class="form-check-label" for="optConversions">Only show rows having conversions</label>
                    </div>
                    <div class="form-check"><input class="form-check-input" type="checkbox"
                            [(ngModel)]="otherOptions.onlyShowRowsHavingRevenue" id="optRevenue"><label
                            class="form-check-label" for="optRevenue">Only show rows having revenue</label></div>
                    <div class="form-check"><input class="form-check-input" type="checkbox"
                            [(ngModel)]="otherOptions.showManagerId" id="optManagerId"><label class="form-check-label"
                            for="optManagerId">Show Manager ID</label></div>
                    <div class="form-check"><input class="form-check-input" type="checkbox"
                            [(ngModel)]="otherOptions.showInProfileCurrency" id="optProfileCurrency"><label
                            class="form-check-label" for="optProfileCurrency">Show in profile currency</label></div>
                    <div class="form-check"><input class="form-check-input" type="checkbox"
                            [(ngModel)]="otherOptions.hideDecimalValues" id="optHideDecimals"><label
                            class="form-check-label" for="optHideDecimals">Hide Decimal Values</label></div>
                </div>
            </div>

            <div class="filter-section">
                <h6 class="section-title">Conditions</h6>
                <div class="conditions-list">
                    <div class="condition-row" *ngFor="let condition of conditions; let i = index">
                        <select class="form-select form-select-sm" [(ngModel)]="condition.field">
                            <option value="">Select Field</option>
                            <option value="grossClicks">Gross Clicks</option>
                            <option value="conversions">Conversions</option>
                            <option value="payout">Payout</option>
                            <option value="revenue">Revenue</option>
                            <option value="profit">Profit</option>
                        </select>
                        <select class="form-select form-select-sm" [(ngModel)]="condition.operator">
                            <option value="equals">Equals</option>
                            <option value="greaterThan">Greater Than</option>
                            <option value="lessThan">Less Than</option>
                            <option value="notEquals">Not Equals</option>
                        </select>
                        <input type="text" class="form-control form-control-sm" [(ngModel)]="condition.value"
                            placeholder="Value">
                        <button class="btn btn-sm btn-outline-danger" (click)="removeCondition(i)"><i
                                class="fas fa-times"></i></button>
                    </div>
                </div>
                <button class="btn btn-outline-primary btn-sm mt-2" (click)="addCondition()"><i
                        class="fas fa-plus me-1"></i> Add Condition</button>
            </div>
        </div>
        <div class="filter-footer"><button class="btn btn-primary" (click)="applyFilters()"><i
                    class="fas fa-check me-1"></i> Submit</button><button class="btn btn-outline-secondary"
                (click)="closeFilterPanel()">Close</button></div>
    </div>

    <div class="modal-overlay" *ngIf="showNewReportModal" (click)="closeNewReportModal()"></div>
    <div class="new-report-modal" *ngIf="showNewReportModal">
        <div class="modal-header">
            <h5 class="modal-title">Create New Report</h5>
        </div>
        <div class="modal-body"><input type="text" class="form-control" [(ngModel)]="newReportName"
                placeholder="Enter Report Name" (keyup.enter)="confirmNewReport()"></div>
        <div class="modal-footer"><button class="btn btn-primary btn-sm"
                (click)="confirmNewReport()">Yes</button><button class="btn btn-outline-secondary btn-sm"
                (click)="closeNewReportModal()">Cancel</button></div>
    </div>
</div>